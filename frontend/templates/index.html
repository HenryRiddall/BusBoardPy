{% extends 'base.html' %}

{% block content %}
    <h1 class="my-3">{% block title %} Welcome to BusBoard {% endblock %}</h1>
    <form name="postcodeForm" method="post">
        <div class="input-group col-md-4">
            <input type="text" class="form-control py-2 border-right-0 border" placeholder="Postcode" name="postcode" id="postcode" value="{{postcode}}">
            <span class="input-group-append">
              <button class="btn btn-outline-secondary border-left-0 border" type="submit">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg>
              </button>
            </span>
        </div>
    </form>
    {%for stop_point in stop_points%}
    <div class="card my-3">
        {% set outer_loop_index = loop.index %}
        <div class="card-header">
            <h1>
                {{stop_point["name"]}}
            </h1>
            <h3>
                <span class="badge badge-info">
                    {{stop_point["indicator"]}}
                </span>
            </h3>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead class="thead-dark">
                    <tr>
                    <th scope="col">Number</th>
                    <th scope="col">Destination</th>
                    <th scope="col">Time to Station</th>
                    </tr>
                </thead>
                <tbody>
                    {%for arrival in stop_point["arrivals"]%}
                    <tr>
                        <td>{{arrival["number"]}}</td>
                        <td>{{arrival["destination"]}}</td>
                        <td id="stop{{ outer_loop_index }}arrival{{ loop.index }}">{{arrival["time_to_station"][0]}}m {{arrival["time_to_station"][1]}}s</td>
                    </tr>
                    <script>
                        let stop{{ outer_loop_index }}arrival{{ loop.index }} = {{arrival["time_to_station"]}}

                        console.log(stop{{ outer_loop_index }}arrival{{ loop.index }})

                        setInterval(() => {
                            document.postcodeForm.submit()
                    }, 30000)

                    setInterval(() => {
                        if (stop{{ outer_loop_index }}arrival{{ loop.index }}[1] > 0){
                            stop{{ outer_loop_index }}arrival{{ loop.index }}[1] = stop{{ outer_loop_index }}arrival{{ loop.index }}[1] - 1
                        }
                        else{
                            stop{{ outer_loop_index }}arrival{{ loop.index }}[1] = 59
                            stop{{ outer_loop_index }}arrival{{ loop.index }}[0] = stop{{ outer_loop_index }}arrival{{ loop.index }}[0] - 1
                        }

                        document.getElementById("stop{{ outer_loop_index }}arrival{{ loop.index }}").innerHTML = `${stop{{ outer_loop_index }}arrival{{ loop.index }}[0]}m ${stop{{ outer_loop_index }}arrival{{ loop.index }}[1]}s`
                    }, 1000)
                    </script>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
{% endblock %}


